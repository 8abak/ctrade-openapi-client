<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ZigZag Explorer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    /* tiny page-specific bits (rest comes from style.css) */
    .row { display:flex; align-items:center; gap:.5rem; margin:.35rem 0; }
    .chip { padding:.15rem .5rem; border:1px solid #444; border-radius:.4rem; }
    .err { color:#ff6b6b; font-family:monospace; margin-top:.5rem; }
  </style>
</head>
<body>
  <div id="container">
    <aside id="sidebar">
      <h2>ZigZag Explorer</h2>

      <div class="row">
        <label>Mode:</label>
        <label class="chip"><input type="radio" name="mode" value="date" checked> By Date</label>
        <label class="chip"><input type="radio" name="mode" value="id"> By Start ID</label>
      </div>

      <div id="byDate">
        <div class="row">
          <label for="day">Day:</label>
          <input id="day" type="date" />
        </div>
      </div>

      <div id="byId" style="display:none">
        <div class="row">
          <label for="startId">Start ID:</label>
          <input id="startId" type="number" placeholder="e.g. 233000" />
        </div>
        <div class="row">
          <label for="span">Span (min):</label>
          <input id="span" type="number" value="60" />
        </div>
      </div>

      <div class="row">
        <label>Levels:</label>
        <label class="chip"><input type="checkbox" class="lvl" value="micro" checked> Micro</label>
        <label class="chip"><input type="checkbox" class="lvl" value="medium" checked> Medium</label>
        <label class="chip"><input type="checkbox" class="lvl" value="maxi" checked> Maxi</label>
      </div>

      <div class="row">
        <button id="loadBtn">Load</button>
        <button id="moreBtn">Load More â†’</button>
      </div>

      <div id="msg" class="err"></div>
      <div id="version"></div>
    </aside>

    <main id="main"></main>
  </div>

  <script>
    // --- UI toggle
    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const byDate = document.getElementById('byDate');
        const byId   = document.getElementById('byId');
        if (document.querySelector('input[name="mode"]:checked').value === 'date') {
          byDate.style.display = ''; byId.style.display = 'none';
        } else { byDate.style.display = 'none'; byId.style.display = ''; }
      });
    });

    // --- chart
    let chart = echarts.init(document.getElementById('main'));
    const COLORS = { micro:'#4dd0e1', medium:'#ffd54f', maxi:'#ff8a65' };
    let lastCursorTs = null; // for Load More

    chart.setOption({
      backgroundColor: '#111',
      tooltip: {
        trigger: 'item',
        axisPointer: { type: 'cross' },
        backgroundColor: '#222',
        borderColor: '#555',
        borderWidth: 1,
        textStyle: { color: '#fff', fontSize: 12 },
        formatter: (p) => {
          const d = new Date(p.value[0]);
          const t = d.toLocaleTimeString('en-AU', { hour12:false });
          const ds = d.toLocaleDateString('en-AU');
          const price = p.value[1];
          const extra = (p.seriesType==='scatter')
            ? `\nKind: ${p.data[2]}`
            : '';
          return `${p.seriesName}\n${ds} ${t}\nPrice: ${price}${extra}`;
        }
      },
      xAxis: { type:'time', axisLabel:{color:'#ccc'}, splitLine:{lineStyle:{color:'#333'}} },
      yAxis: { type:'value', scale:true, axisLabel:{color:'#ccc'}, splitLine:{lineStyle:{color:'#333'}} },
      dataZoom: [{type:'inside'}, {type:'slider', height:40, bottom:0}],
      series: []
    });

    function segsToPolyline(segments) {
      // convert [{start_ts,end_ts,start_price,end_price},...] to
      // [ [ts,price], [ts,price], [null,null], ... ] so lines break between segments
      const out = [];
      for (const s of segments) {
        out.push([Date.parse(s.start_ts), s.start_price]);
        out.push([Date.parse(s.end_ts),   s.end_price]);
        out.push([null, null]); // gap
      }
      return out;
    }

    function pointsToScatter(points) {
      // [{ts,price,kind},...] -> [[ts,price,kind],...]
      return points.map(p => [Date.parse(p.ts), p.price, p.kind]);
    }

    function currentLevels() {
      return Array.from(document.querySelectorAll('.lvl:checked')).map(x=>x.value);
    }

    async function fetchZigzag({append=false}={}) {
      const msg = document.getElementById('msg'); msg.textContent = '';
      const levels = currentLevels().join(',');
      if (!levels) { msg.textContent = 'Select at least one level.'; return; }

      const mode = document.querySelector('input[name="mode"]:checked').value;
      const params = new URLSearchParams({ levels, limit: '2000', mode });

      if (mode === 'date') {
        const dayInput = document.getElementById('day').value;
        if (!dayInput) { msg.textContent = 'Pick a day.'; return; }
        // normalize to YYYY-MM-DD for backend
        const isoDay = new Date(dayInput).toISOString().slice(0,10);
        params.set('day', isoDay);
        if (append && lastCursorTs) params.set('cursor_ts', lastCursorTs);
      } else {
        const id = document.getElementById('startId').value.trim();
        const span = document.getElementById('span').value.trim() || '60';
        if (!id) { msg.textContent = 'Enter Start ID.'; return; }
        params.set('start_id', id); params.set('span_minutes', span);
        if (append && lastCursorTs) params.set('cursor_ts', lastCursorTs);
      }

      const url = `/zigzag?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) {
        msg.textContent = `Error ${res.status}`;
        return;
      }
      const payload = await res.json();
      lastCursorTs = payload?.meta?.cursor_ts || null;

      // Build/append series per level
      const series = chart.getOption().series || [];
      const seriesIndexByName = Object.fromEntries(series.map((s,i)=>[s.name,i]));

      for (const lvl of ['micro','medium','maxi']) {
        if (!levels.includes(lvl)) continue;

        const segs = payload.segments?.[lvl] || [];
        const pts  = payload.points?.[lvl]   || [];

        // line series (broken lines via null gaps)
        const lineName = `${lvl} segments`;
        const lineData = segsToPolyline(segs);
        if (seriesIndexByName[lineName] == null) {
          series.push({
            name: lineName,
            type: 'line',
            showSymbol: false,
            connectNulls: false,
            lineStyle: { width: 2, color: COLORS[lvl] },
            itemStyle: { color: COLORS[lvl] },
            data: lineData
          });
        } else if (append) {
          // append new chunk
          series[seriesIndexByName[lineName]].data.push(...lineData);
        } else {
          series[seriesIndexByName[lineName]].data = lineData;
        }

        // point series (peaks/troughs)
        const ptName = `${lvl} points`;
        const ptData = pointsToScatter(pts);
        if (seriesIndexByName[ptName] == null) {
          series.push({
            name: ptName,
            type: 'scatter',
            symbolSize: 6,
            itemStyle: { color: COLORS[lvl] },
            data: ptData
          });
        } else if (append) {
          series[seriesIndexByName[ptName]].data.push(...ptData);
        } else {
          series[seriesIndexByName[ptName]].data = ptData;
        }
      }

      chart.setOption({ series }, { replaceMerge:['series'] });
    }

    document.getElementById('loadBtn').addEventListener('click', ()=>{ lastCursorTs=null; fetchZigzag({append:false}); });
    document.getElementById('moreBtn').addEventListener('click', ()=> fetchZigzag({append:true}) );

    // default day = first available from zigzag_points? fallback to today
    (async function bootstrap(){
      try {
        const v = await fetch('/version').then(r=>r.json()).catch(()=>null);
        if (v) document.getElementById('version').textContent = v.version || '';
      } catch {}
      const d = new Date(); document.getElementById('day').value = d.toISOString().slice(0,10);
    })();
  </script>
</body>
</html>

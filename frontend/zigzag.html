<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ZigZag Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    body{background:#0f1115;color:#c9d1d9}
    .page{display:grid;grid-template-columns:260px 1fr;height:100vh}
    .side{padding:14px;border-right:1px solid #1f232b;overflow:auto}
    .row{margin:10px 0}.small{font-size:12px;color:#9aa4b2}
    .btn{background:#1677ff;border:0;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#2d333b}.btn:disabled{opacity:.5}
    #chart{height:calc(100vh - 0px)}
    .kv{display:flex;justify-content:space-between;font-size:12px;padding:3px 0;border-bottom:1px dashed #1f232b}
    .badge{display:inline-block;padding:2px 6px;border-radius:10px;background:#1f232b;font-size:12px;margin-left:6px}
    .legend-dots{display:flex;gap:10px;margin-top:6px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
  </style>
</head>
<body>
<div class="page">
  <aside class="side">
    <h1 style="margin:8px 0 12px">ZigZag Explorer</h1>

    <div class="row">
      <div class="small">Mode:</div>
      <label><input type="radio" name="mode" value="date" checked> By Date</label>
      <label><input type="radio" name="mode" value="id"> By Start ID</label>
    </div>

    <div class="row" id="dayRow">
      <div class="small">Day:</div>
      <input id="day" type="date"/>
    </div>

    <div class="row" id="idRow" style="display:none">
      <div class="small">Start tick id:</div>
      <input id="startId" type="number" style="width:140px"/>
      <div class="small" style="margin-top:6px">Span (minutes):</div>
      <input id="spanMin" type="number" value="60" style="width:80px"/>
    </div>

    <div class="row">
      <div class="small">Levels:</div>
      <label><input type="checkbox" class="lvl" value="micro" checked> Micro</label>
      <label><input type="checkbox" class="lvl" value="medium" checked> Medium</label>
      <label><input type="checkbox" class="lvl" value="maxi"> Maxi</label>
      <div class="legend-dots small">
        <span><i class="dot" style="background:#00b7ff"></i>Micro</span>
        <span><i class="dot" style="background:#ff6b6b"></i>Medium</span>
        <span><i class="dot" style="background:#7c4dff"></i>Maxi</span>
      </div>
    </div>

    <div class="row">
      <button id="loadBtn" class="btn">Load</button>
      <button id="moreBtn" class="btn secondary" disabled>Load More →</button>
    </div>

    <div class="small" id="status">Ready.</div>

    <div class="row">
      <div class="small">Selected segment</div>
      <div id="selNone" class="small">Click a line or point…</div>
      <div id="selBox" style="display:none">
        <div class="kv"><span>Level</span> <span id="sLevel"></span></div>
        <div class="kv"><span>Start</span> <span id="sStart"></span></div>
        <div class="kv"><span>End</span> <span id="sEnd"></span></div>
        <div class="kv"><span>Δ Price</span> <span id="sDeltaP"></span></div>
        <div class="kv"><span>Δ Time</span> <span id="sDeltaT"></span></div>
        <div class="kv"><span>Ticks</span> <span id="sTicks"></span></div>
      </div>
    </div>

    <div class="row small">Version <span class="badge" id="ver">…</span></div>
  </aside>

  <main><div id="chart"></div></main>
</div>

<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
function fmtTs(iso){ try{return new Date(iso).toLocaleString()}catch(e){return iso} }
function fmtNum(n){ return (Math.round(n*100)/100).toLocaleString() }
function pad2(n){ return String(n).padStart(2,'0') }
function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}` }

/* ---------- state ---------- */
const state = {
  mode:'date', day: todayISO(), startId:null, spanMin:60,
  levels:new Set(['micro','medium']),
  segments:{micro:[],medium:[],maxi:[]},
  pointStore:{micro:[],medium:[],maxi:[]},
  seen:{micro:new Set(),medium:new Set(),maxi:new Set()},
  cursor:null,
};

$('#day').value = state.day;
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',e=>{
  state.mode=e.target.value;
  $('#dayRow').style.display = state.mode==='date'?'':'none';
  $('#idRow').style.display  = state.mode==='id'?'':'none';
}));
document.querySelectorAll('.lvl').forEach(cb=>cb.addEventListener('change',()=>{
  cb.checked?state.levels.add(cb.value):state.levels.delete(cb.value);
  applyLegendSelection();
}));

/* ---------- chart ---------- */
const chart = echarts.init(document.getElementById('chart'), null, {useDirtyRect:true});
const SERIES_INDEX = { microLine:0, mediumLine:1, maxiLine:2, microDots:3, mediumDots:4, maxiDots:5 };

chart.setOption({
  backgroundColor:'#0f1115', animation:false,
  grid:{left:40,right:20,top:16,bottom:60},
  tooltip:{trigger:'axis',axisPointer:{type:'cross'},textStyle:{fontSize:12}},
  legend:{top:0,textStyle:{color:'#c9d1d9'}},
  xAxis:{type:'time',axisLine:{lineStyle:{color:'#334155'}},axisLabel:{color:'#9aa4b2'}},
  yAxis:{type:'value',scale:true,axisLine:{lineStyle:{color:'#334155'}},
         axisLabel:{color:'#9aa4b2'},splitLine:{lineStyle:{color:'#1f232b'}}},
  dataZoom:[
    {type:'inside',filterMode:'filter'},
    {type:'slider',height:18,bottom:28,borderColor:'#1f232b',textStyle:{color:'#8b949e'},filterMode:'filter'}
  ],
  series:[
    {name:'Micro', type:'line', data:[], showSymbol:false, connectNulls:false, sampling:'lttb', clip:true,
     lineStyle:{width:0.8,color:'#00b7ff',opacity:.95}, zlevel:1},
    {name:'Medium', type:'line', data:[], showSymbol:false, connectNulls:false, sampling:'lttb', clip:true,
     lineStyle:{width:1.1,color:'#ff6b6b',opacity:.9}, zlevel:1},
    {name:'Maxi', type:'line', data:[], showSymbol:false, connectNulls:false, sampling:'lttb', clip:true,
     lineStyle:{width:1.4,color:'#7c4dff',opacity:.9}, zlevel:1},
    {name:'Micro pts', type:'scatter', data:[], symbolSize:2.6, itemStyle:{color:'#ffd54d'}, zlevel:2},
    {name:'Medium pts', type:'scatter', data:[], symbolSize:3.0, itemStyle:{color:'#ff9f43'}, zlevel:2},
    {name:'Maxi pts', type:'scatter', data:[], symbolSize:3.4, itemStyle:{color:'#a78bfa'}, zlevel:2},
  ]
});

/* Click → segment details */
chart.on('click', params=>{
  const name=(params.seriesName||'').toLowerCase();
  const lvl = name.includes('micro')?'micro':name.includes('medium')?'medium':name.includes('maxi')?'maxi':null;
  if(!lvl) return;
  const ts = new Date(params.value[0] ?? params.data[0]).toISOString();
  const seg = nearestSegment(lvl, ts);
  if(!seg){ $('#selNone').style.display=''; $('#selBox').style.display='none'; return; }
  const dSec=(new Date(seg.end_ts)-new Date(seg.start_ts))/1000;
  const dP=(seg.end_price-seg.start_price);
  $('#sLevel').textContent=lvl;
  $('#sStart').textContent=fmtTs(seg.start_ts);
  $('#sEnd').textContent=fmtTs(seg.end_ts);
  $('#sDeltaP').textContent=`${dP>=0?'+':''}${fmtNum(dP)}`;
  $('#sDeltaT').textContent=`${Math.floor(dSec/60)}m ${Math.round(dSec%60)}s`;
  $('#sTicks').textContent=(seg.num_ticks!=null?seg.num_ticks:'n/a');
  $('#selNone').style.display='none'; $('#selBox').style.display='';
});
function nearestSegment(level, isoTs){
  const arr=state.segments[level]; if(!arr.length) return null;
  const t=new Date(isoTs).getTime(); let best=null,bestd=Infinity;
  for(const s of arr){ const mid=(+new Date(s.start_ts)+ +new Date(s.end_ts))/2; const d=Math.abs(mid-t); if(d<bestd){bestd=d;best=s;} }
  return best;
}

/* ---------- stable building from points ---------- */
const GAP_MS = 30*60*1000; // break line across >30 min gaps

function stableSortAndClean(points){
  // numeric sort + drop non-increasing timestamps
  const arr = points.slice().sort((a,b)=> new Date(a.ts).getTime() - new Date(b.ts).getTime());
  const out = [];
  let lastT = -Infinity, lastKey = '';
  for(const p of arr){
    const t = new Date(p.ts).getTime();
    if (t < lastT) continue;            // drop out-of-order
    const key = p.ts+'|'+p.price;       // tolerate equal ts with different price by treating as distinct only if price differs
    if (t===lastT && key===lastKey) continue; // exact dup
    out.push({ts:p.ts,price:p.price});
    lastT=t; lastKey=key;
  }
  return out;
}

function rebuildPath(level){
  const iLine = SERIES_INDEX[level+'Line'];
  const iDots = SERIES_INDEX[level+'Dots'];

  const pts = stableSortAndClean(state.pointStore[level]);
  const line=[], dots=[];
  let prev=null;
  for(const p of pts){
    const t = new Date(p.ts).getTime();
    if(prev && (t - prev.t) > GAP_MS){
      // add a hard break
      line.push([prev.ts, null]);
    }
    line.push([p.ts, p.price]);
    dots.push([p.ts, p.price]);
    prev = {t, ts:p.ts};
  }

  const series = chart.getOption().series;
  series[iLine].data = line;
  series[iDots].data = dots;
  chart.setOption({series});
}

function pushPoints(level, points){
  if(!points?.length) return;
  const seen = state.seen[level], store = state.pointStore[level];
  for(const p of points){
    const key=p.ts+'|'+p.price; // more robust than ts only
    if(seen.has(key)) continue;
    seen.add(key);
    store.push({ts:p.ts,price:p.price});
  }
  rebuildPath(level);
}
function pushSegments(level, segs){
  if(!segs?.length) return;
  state.segments[level].push(...segs);
}

/* ---------- loading ---------- */
$('#loadBtn').addEventListener('click', ()=>load(true));
$('#moreBtn').addEventListener('click', ()=>load(false));

async function load(first){
  if(first){
    state.segments={micro:[],medium:[],maxi:[]};
    state.pointStore={micro:[],medium:[],maxi:[]};
    state.seen={micro:new Set(),medium:new Set(),maxi:new Set()};
    state.cursor=null;
    // clear chart series
    const S=chart.getOption().series; for(let i=0;i<S.length;i++) S[i].data=[];
    chart.setOption({series:S});
    $('#selNone').style.display=''; $('#selBox').style.display='none';
  }

  const levels = Array.from(state.levels).join(',');
  const base = '/api/zigzag';
  const params = new URLSearchParams({ levels, limit:'2000' });

  if(state.mode==='date'){
    state.day = $('#day').value || state.day;
    params.set('mode','date'); params.set('day',state.day);
    if(state.cursor) params.set('cursor_ts', state.cursor);
  }else{
    params.set('mode','id');
    state.startId = Number($('#startId').value||0);
    state.spanMin = Number($('#spanMin').value||60);
    if(!state.startId){ setStatus('Missing start id'); return; }
    params.set('start_id', String(state.startId));
    params.set('span_minutes', String(state.spanMin));
    if(state.cursor) params.set('cursor_ts', state.cursor);
  }

  setStatus('Loading…'); $('#loadBtn').disabled=true; $('#moreBtn').disabled=true;
  try{
    const r = await fetch(`${base}?${params.toString()}`, {cache:'no-store'});
    if(!r.ok){ setStatus(`Error ${r.status}`); return; }
    const payload = await r.json();

    const segs = payload.segments||{}, pts = payload.points||{};
    if(segs.micro)  pushSegments('micro',  segs.micro);
    if(segs.medium) pushSegments('medium', segs.medium);
    if(segs.maxi)   pushSegments('maxi',   segs.maxi);

    if(pts.micro)  pushPoints('micro',  pts.micro);
    if(pts.medium) pushPoints('medium', pts.medium);
    if(pts.maxi)   pushPoints('maxi',   pts.maxi);

    state.cursor = (payload.meta&&payload.meta.cursor_ts)||null;
    setStatus('Loaded');
    $('#moreBtn').disabled = !state.cursor;
  }catch(e){
    console.error(e); setStatus('Network error');
  }finally{
    $('#loadBtn').disabled=false;
  }
}

function setStatus(m){ $('#status').textContent=m }

/* ---------- legend ↔ checkboxes ---------- */
function applyLegendSelection(){
  const opt = chart.getOption();
  opt.legend[0].selected = {
    'Micro': state.levels.has('micro'),
    'Micro pts': state.levels.has('micro'),
    'Medium': state.levels.has('medium'),
    'Medium pts': state.levels.has('medium'),
    'Maxi': state.levels.has('maxi'),
    'Maxi pts': state.levels.has('maxi'),
  };
  chart.setOption({legend: opt.legend});
}

/* ---------- version label ---------- */
(async ()=>{ try{ const r=await fetch('/version'); if(r.ok){ const j=await r.json(); $('#ver').textContent=j.version||'—'; } }catch(_){} })();

/* defaults */
applyLegendSelection();
setStatus('Ready. Choose a day and press Load.');
</script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Loop View</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <link rel="stylesheet" href="/frontend/style.css" />
  <style>
    body { background:#111; color:#eee; margin:0; font-family:system-ui, sans-serif; }
    #ctrl { padding:10px; }
    #chart { width:100vw; height:88vh; }
    input, button { background:#222; color:#eee; border:1px solid #444; padding:6px 8px; }
  </style>
</head>
<body>
  <div id="ctrl">
    <label>Day (UTC): <input id="day" value=""></label>
    <button onclick="reload()">Load</button>
    <span id="status"></span>
  </div>
  <div id="chart"></div>

  <script>
    const apiBase = location.origin + '/api';
    const chart = echarts.init(document.getElementById('chart'));

    function baseOption(){
      return {
        backgroundColor:'#111',
        animation:false,
        tooltip:{ trigger:'axis' },
        xAxis:{ type:'time' },
        yAxis:{ type:'value', scale:true },
        series:[
          { name:'Zigs', type:'line', data:[], showSymbol:false, lineStyle:{ width:2 } },
          { name:'Active Zig Ticks', type:'line', data:[], showSymbol:false, lineStyle:{ width:1 } }
        ]
      };
    }

    async function loadZigs(day){
      const res = await fetch(`${apiBase}/zigs?day=${day}`);
      const zigs = await res.json();
      const segs = [];
      for (const z of zigs){
        segs.push([z.start_time, z.start_price]);
        segs.push([z.end_time,   z.end_price]);
        segs.push([null,null]); // break between segments
      }
      const opt = baseOption();
      opt.series[0].data = segs;
      chart.setOption(opt, true);
    }

    async function loadActive(day){
      const res = await fetch(`${apiBase}/active?day=${day}`);
      const js = await res.json();
      const arr = js.ticks.map(t => [t.ts, t.mid]);
      chart.setOption({ series:[{}, { data: arr }] });
      document.getElementById('status').textContent = `Active ticks: ${arr.length}`;
    }

    let timer = null;
    function reload(){
      const day = document.getElementById('day').value;
      loadZigs(day);
      if (timer) clearInterval(timer);
      loadActive(day);
      timer = setInterval(() => loadActive(day), 1500);
    }

    // default to today UTC
    const now = new Date();
    const yyyy = now.getUTCFullYear();
    const mm = String(now.getUTCMonth()+1).padStart(2,'0');
    const dd = String(now.getUTCDate()).padStart(2,'0');
    document.getElementById('day').value = `${yyyy}-${mm}-${dd}`;
    reload();
  </script>
</body>
</html>

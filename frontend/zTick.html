<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ZTick Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #111;
      color: white;
      font-family: sans-serif;
    }
    #container {
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 280px;
      padding: 1em;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    label { font-size: 13px; margin-top: 4px; }
    select, input, button, textarea {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      background: #222;
      color: white;
      border: 1px solid #555;
      margin-top: 4px;
    }
    input[type="checkbox"] {
      margin-right: 6px;
    }
    #main {
      flex-grow: 1;
    }
    .section { margin-bottom: 1em; }
    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <div>
      <h3>ZTick View</h3>

      <div class="section">
        <label for="startTime">Start Time</label>
        <input type="text" id="startTime" placeholder="dd/mm/yyyy hh:mm">
      </div>

      <div class="section">
        <label for="endTime">End Time</label>
        <input type="text" id="endTime" placeholder="dd/mm/yyyy hh:mm">
      </div>

      <button onclick="loadZTickChart()">Load Chart</button>

      <div class="section">
        <strong>Series</strong><br>
        <div class="checkbox-row">
          <label><input type="checkbox" id="askCheckbox"> Ask</label>
          <label><input type="checkbox" id="midCheckbox" checked> Mid</label>
          <label><input type="checkbox" id="bidCheckbox"> Bid</label>
        </div>
      </div>

      <div id="labelCheckboxes" class="section checkbox-row"></div>

      <div class="section">
        <strong>Selected Tick:</strong> <span id="selectedIdsText">None</span>
        <select id="labelTableSelect"></select>
        <input type="text" id="customTickIds" placeholder="Extra Tick IDs (e.g., 53212,53214-53220)">
        <textarea id="labelNote" rows="2" placeholder="Optional label note..."></textarea>
        <button onclick="submitLabel()">Submit Labels</button>
        <button onclick="exportSelectedTicks()">Export CSV</button>
      </div>

      <div class="section">
        <strong>SQL Console</strong><br>
        <select id="tableSelect"></select>
        <textarea id="queryInput" rows="5" placeholder="Write SQL query..."></textarea>
        <button onclick="runQuery()">Run</button>
        <div id="sqlResult" style="margin-top: 6px; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>

    <div id="version" style="font-size: 11px; color: #777; text-align: left;"></div>
  </div>
  <div id="main"></div>
</div>
<script>
  const AVAILABLE_LABELS_ENDPOINT = "/available";

  async function loadTableNames() {
    try {
      const res = await fetch(AVAILABLE_LABELS_ENDPOINT);
      const tables = await res.json();
      const select = document.getElementById('tableSelect');
      select.innerHTML = tables.map(t => `<option value="${t}">${t}</option>`).join('');
    } catch (e) {
      document.getElementById('sqlResult').innerHTML = `<pre style="color:red">Error loading tables: ${e}</pre>`;
    }
  }

  async function runQuery() {
    const table = document.getElementById('tableSelect').value;
    const raw = document.getElementById('queryInput').value.trim();
    const query = raw || `SELECT * FROM ${table} LIMIT 100;`;
    const container = document.getElementById('sqlResult');
    container.innerHTML = `<pre style="color: #999;">Running query...</pre>`;

    try {
      const res = await fetch(`/sqlvw/query?query=${encodeURIComponent(query)}`);
      const text = await res.text();
      try {
        const json = JSON.parse(text);
        if (Array.isArray(json)) {
          if (json.length === 0) return container.innerHTML = '<p>No results.</p>';
          const headers = Object.keys(json[0]);
          let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
          for (const row of json) html += '<tr>' + headers.map(h => `<td>${row[h]}</td>`).join('') + '</tr>';
          html += '</tbody></table>';
          container.innerHTML = html;
        } else {
          container.innerHTML = `<pre>${JSON.stringify(json, null, 2)}</pre>`;
        }
      } catch {
        container.innerHTML = `<pre style="color: green;">${text}</pre>`;
      }
    } catch (e) {
      container.innerHTML = `<pre style="color:red">Error: ${e.message}</pre>`;
    }
  }
</script>
<script>
  let chartRef;
  window.addEventListener("DOMContentLoaded", () => {
    chartRef = echarts.init(document.getElementById("main"));
    chartRef.getZr().on("click", function (params) {
      const pointInPixel = [params.offsetX, params.offsetY];
      const pointInGrid = chartRef.convertFromPixel({ seriesIndex: 0 }, pointInPixel);
      const clickedTime = pointInGrid[0];

      const allData = [...(window.dataMid || [])];
      if (!allData.length) return;
      let closest = allData[0];
      let minDist = Math.abs(closest[0] - clickedTime);

      for (const p of allData) {
        const dist = Math.abs(p[0] - clickedTime);
        if (dist < minDist) {
          minDist = dist;
          closest = p;
        }
      }

      if (closest) {
        window.selectedTickIds = [closest[2]];
        document.getElementById("selectedIdsText").textContent = closest[2];
        highlightSelectedTick(closest[2]);
      }
    });
    loadTableNames();
  });

  function highlightSelectedTick(tickId) {
    const series = chartRef.getOption().series || [];
    const overlay = window.dataMid.filter(d => d[2] === tickId);
    const mark = overlay.length ? [{ name: 'Selected', type: 'scatter', symbolSize: 8, itemStyle: { color: '#fff' }, data: overlay }] : [];
    chartRef.setOption({ series: [...series.filter(s => s.name !== 'Selected'), ...mark] }, { replaceMerge: ['series'], lazyUpdate: true });
  }
</script>
<script src="ztick-core.js"></script>
</body>
</html>

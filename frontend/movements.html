<!DOCTYPE html><meta charset="utf-8">
<title>Movements (Small vs Big)</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<body style="margin:0;background:#111;color:#fff;font-family:sans-serif;">
<div style="padding:8px;display:flex;gap:8px;align-items:center">
  <label>Day (UTC): <input id="day" type="date"></label>
  <button onclick="loadDay()">Load</button>
  <button onclick="loadLatest()">Last 24h</button>
</div>
<div id="chart" style="height: calc(100vh - 48px); width: 100vw;"></div>
<script>
const chart = echarts.init(document.getElementById('chart'));

function toRects(trends, laneY, h) {
  return trends.map(t => ({
    name: t.scale===2?'Big (≥$3)':'Small',
    value: [new Date(t.start_ts).getTime(), laneY, new Date(t.end_ts).getTime(), laneY+h,
            t.direction>0?'+':'-', t.magnitude, t.duration_sec],
    itemStyle: { color: t.direction>0?'rgba(0,180,0,0.35)':'rgba(220,0,0,0.35)' },
    emphasis: { focus: 'self' },
  }));
}

function makeSeries(name, data, z){
  return {
    type:'custom', name, z,
    renderItem:(params, api)=>{
      const x0=api.coord([api.value(0),0])[0], x1=api.coord([api.value(2),0])[0];
      const y0=api.coord([0, api.value(1)])[1], y1=api.coord([0, api.value(3)])[1];
      return {type:'rect', shape:{x:x0,y:y0,width:x1-x0,height:y1-y0}, style: api.style()};
    },
    encode:{x:[0,2], y:[1,3]},
    data
  };
}

function render(dayText, small, big){
  const s = toRects(small, 0.1, 0.35);
  const b = toRects(big,   0.6, 0.35);
  chart.setOption({
    backgroundColor:'#111',
    title:{text:`Movements — ${dayText}`, left:10, top:6, textStyle:{color:'#fff', fontSize:14}},
    tooltip:{
      trigger:'item',
      formatter: p => {
        const v = p.value, minutes = Math.round(v[6]/60);
        return `${p.seriesName}<br>${v[4]}${v[5].toFixed(2)} in ${minutes}m`;
      }
    },
    xAxis:{type:'time', axisLabel:{color:'#ccc'}},
    yAxis:{type:'value', min:0, max:1, axisLabel:{show:false}, splitLine:{show:false}},
    dataZoom:[{type:'inside'},{type:'slider'}],
    series:[
      makeSeries('Big (≥$3)', b, 5),
      makeSeries('Small', s, 3),
    ]
  });
}

async function loadDay(){
  const day = document.getElementById('day').value;
  if (!day) return;
  const [small, big] = await Promise.all([
    fetch(`/trends/day?day=${day}&scale=1`).then(r=>r.json()),
    fetch(`/trends/day?day=${day}&scale=2`).then(r=>r.json())
  ]);
  render(day, small, big);
}

async function loadLatest(){
  const end = new Date();
  const start = new Date(end.getTime() - 24*3600*1000);
  const [small, big] = await Promise.all([
    fetch(`/trends/range?start=${start.toISOString()}&end=${end.toISOString()}&scale=1`).then(r=>r.json()),
    fetch(`/trends/range?start=${start.toISOString()}&end=${end.toISOString()}&scale=2`).then(r=>r.json())
  ]);
  render('Last 24h (UTC)', small, big);
}

document.getElementById('day').value = new Date().toISOString().slice(0,10);
loadDay();
</script>
</body>
